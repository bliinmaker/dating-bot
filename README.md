# Телеграм-бот для знакомств

Этот проект представляет собой Telegram-бота для знакомств с архитектурой микросервисов, использующий современные технологии для обеспечения масштабируемости и производительности.

## Особенности

- Регистрация и создание анкет
- Загрузка и хранение фотографий в S3-совместимом хранилище
- Алгоритм ранжирования анкет на основе различных факторов
- Система лайков и мэтчей
- Чат между пользователями, нашедшими совпадения
- Кэширование данных в Redis
- Асинхронная обработка задач с Celery
- Обмен сообщениями между сервисами через RabbitMQ
- Логирование и метрики

## Технологический стек

- Python 3.9+
- Python-Telegram-Bot (PTB)
- PostgreSQL
- Redis
- RabbitMQ
- Celery
- MinIO (S3-совместимое хранилище)
- Docker и Docker Compose

## Архитектура системы

Система построена на основе микросервисной архитектуры и включает следующие компоненты:

```
+----------------------+     +-----------------+     +-----------------+
|                      |     |                 |     |                 |
| Telegram Bot API <---+---->| Bot Service     |<--->| User Service    |
|                      |     |                 |     |                 |
+----------------------+     +-----------------+     +-----------------+
                             |                 |
                             v                 v
+----------------------+     +-----------------+     +-----------------+
|                      |     |                 |     |                 |
| S3 Storage (MinIO) <-+---->| Profile Service |<--->| Matching Service|
|                      |     |                 |     |                 |
+----------------------+     +-----------------+     +-----------------+
                             |                 |
                             v                 v
+----------------------+     +-----------------+     +-----------------+
|                      |     |                 |     |                 |
| Redis Cache <--------+---->| Rating Service  |<--->| Background Tasks|
|                      |     |                 |     | (Celery)        |
+----------------------+     +-----------------+     +-----------------+
                                     ^
                                     |
+----------------------+             |
|                      |             |
| PostgreSQL DB <------+-------------+
|                      |
+----------------------+
```

## Описание сервисов

### Bot Service
Основной сервис, отвечающий за взаимодействие с пользователями через Telegram API. Обрабатывает команды, сообщения и действия пользователей, управляет состояниями пользовательских сессий.

### User Service
Сервис управления пользователями, отвечающий за хранение и обновление базовой информации о пользователях системы.

### Profile Service
Сервис управления анкетами пользователей, отвечающий за CRUD операции с профилями, включая управление фотографиями.

### Matching Service
Сервис для обработки взаимодействий между пользователями, включая лайки и создание совпадений (матчей).

### Rating Service
Сервис для расчета и обновления рейтингов профилей, используемых для ранжирования анкет при показе пользователям.

## Алгоритм рейтинга

### Уровень 1: Первичный рейтинг
- Учитывает данные из анкеты пользователя (возраст, пол, интересы, географическое положение)
- Оценивает полноту заполнения анкеты и количество загруженных фотографий
- Включает первичные предпочтения пользователя (возрастной диапазон, пол, город)

### Уровень 2: Поведенческий рейтинг
- Динамически корректируется на основе взаимодействия других пользователей с анкетой
- Учитывает количество лайков анкеты и соотношение лайков и пропусков
- Оценивает частоту взаимных лайков (мэтчей) и инициирования диалогов после мэтча

### Уровень 3: Комбинированный рейтинг
- Интегрирует первичный и поведенческий рейтинги по весовой модели
- Применяет динамические коэффициенты для адаптации к меняющимся паттернам взаимодействия

## Особенности реализации

### Использование Redis
- Кэширование профилей и списков профилей
- Хранение временных данных и результатов асинхронных задач
- Оптимизация производительности за счет снижения нагрузки на базу данных

### Применение Celery
- Асинхронное выполнение ресурсоемких операций
- Периодический пересчет рейтингов
- Предварительная загрузка профилей
- Очистка устаревших данных

### MQ брокер (RabbitMQ)
- Обеспечение асинхронной коммуникации между сервисами
- Балансировка нагрузки между рабочими процессами
- Буферизация сообщений для повышения надежности системы
- Поддержка отказоустойчивости при сбоях отдельных компонентов

### S3 хранилище (MinIO)
- Хранение фотографий пользователей
- Генерация предварительно подписанных URL для доступа к файлам
- Эффективное управление пользовательским контентом

### Метрики и логирование
- Детальное логирование всех операций системы
- Отслеживание ошибок и предупреждений
- Настраиваемые уровни логирования
- Журналирование действий пользователей

## Схема данных в БД

### Таблица Users
- Базовая информация о пользователях Telegram
- Отслеживание активности и регистрации

### Таблица Profiles
- Детальная информация о пользователях
- Предпочтения для поиска
- Статистика заполненности

### Таблица Photos
- Ссылки на фотографии в S3 хранилище
- Поддержка Telegram file_id для оптимизации

### Таблица Ratings
- Хранение рейтингов профилей
- Компоненты рейтинга (первичный, поведенческий, комбинированный)
- История расчетов

### Таблица Interactions
- Запись всех взаимодействий между пользователями
- Лайки и пропуски

### Таблица Matches
- Взаимные симпатии между пользователями
- Отслеживание статуса общения

## Запуск проекта

### Требования
- Docker и Docker Compose
- Telegram Bot Token

### Шаги запуска
1. Клонировать репозиторий
2. Создать файл `.env` на основе шаблона и заполнить необходимыми данными
3. Запустить контейнеры:
   ```
   docker-compose up -d
   ```
4. Бот готов к использованию!

## Развертывание

Проект полностью контейнеризован и может быть развернут на любом сервере с поддержкой Docker. Все настройки производятся через переменные окружения в файле `.env`.